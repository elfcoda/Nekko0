<!DOCTYPE html>
<html>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
{% load static %}
<link href="{% static 'polls/msgboard7.css' %}" rel="stylesheet" type="text/css" />

<script type="text/javascript">
    function load(){
        //固定显示7页
        var show_max = 7;
        var msg = document.getElementById("info").innerHTML;
        var all_page_num = msg.split('_')[0];
        var cur_page = msg.split('_')[1];
        var article_id = msg.split('_')[2];
        //回传ArticleId(用于表单提交)
        var getArticleIds = document.getElementsByName("get-article-id");
        var iFormSize = getArticleIds.length;
        for (var ar_i = 0; ar_i < iFormSize; ar_i ++)
        {
            getArticleIds[ar_i].value = article_id;
        }
        //回传page(用于表单提交)
        var getPageReplys = document.getElementsByName("get-page");
        var iPageReplySize = getPageReplys.length;
        for (var gPareply_i = 0; gPareply_i < iPageReplySize; gPareply_i ++)
        {
            getPageReplys[gPareply_i].value = cur_page;
        }
        document.getElementById("get-page-comment").value = "1";

        document.getElementById('first-page').style.display = "inline-block";
        document.getElementById('first-page').href = "/polls/msgboard/" + article_id + "/1";
        document.getElementById('last-page').style.display = "inline-block";
        document.getElementById('last-page').href = "/polls/msgboard/" + article_id + "/" + all_page_num;
        var comment_e = document.getElementById('reply-form-comment').lastElementChild.lastElementChild.previousElementSibling;
        comment_e.placeholder = "说点什么吧...";
        comment_e.setAttribute('rows', '3');

        if (all_page_num <= show_max)
        {
            for (var i = 1; i <= all_page_num; ++i)
            {
                var id = "page" + i;
                var e = document.getElementById(id);
                e.style.display = "inline-block";
                e.innerHTML = i;
                e.href = "/polls/msgboard/" + article_id + "/" + i;
                if (i == cur_page)
                {
                    e.setAttribute('class', 'active');
                }
            }
        }
        else
        {
            //判断当前页和总页
            //1 2 3 4 5 6 7 8 9 10
            var half = Math.round(show_max / 2);
            if (cur_page <= half)
            {
                //显示前面showmnax页
                for (var p_n = 1; p_n <= show_max; p_n ++)
                {
                    var p_id = "page" + p_n;
                    var p_e = document.getElementById(p_id);
                    p_e.style.display = "inline-block";
                    p_e.innerHTML = p_n;
                    p_e.href = "/polls/msgboard/" + article_id + "/" + p_n;
                    if (cur_page == p_n)
                    {
                        p_e.setAttribute('class', 'active');
                    }
                }
            }
            else if (cur_page > all_page_num-half)
            {
                //显示后面showmax页
                for (var b_n = all_page_num-show_max+1, b_i = 1; b_n <= all_page_num, b_i <= show_max; b_n ++, b_i ++)
                {
                    var b_id = "page" + b_i;
                    var b_e = document.getElementById(b_id);
                    b_e.style.display = "inline-block";
                    b_e.innerHTML = b_n;
                    b_e.href = "/polls/msgboard/" + article_id + "/" + b_n;
                    if (cur_page == b_n)
                    {
                        b_e.setAttribute('class', 'active');
                    }
                }
            }
            else
            {
                // eg:5 6, 显示前三 当前 后三
                for (var m1_i = 1, m1_n = cur_page-half+1; m1_i <= half-1, m1_n < cur_page; m1_i ++, m1_n ++)
                {
                    var m1_id = "page" + m1_i;
                    var m1_e = document.getElementById(m1_id);
                    m1_e.style.display = "inline-block";
                    m1_e.innerHTML = m1_n;
                    m1_e.href = "/polls/msgboard/" + article_id + "/" + m1_n;
                }
                var m2_e = document.getElementById("page4");
                m2_e.style.display = "inline-block";
                m2_e.innerHTML = cur_page;
                m2_e.setAttribute('class', 'active');
                m2_e.href = "/polls/msgboard/" + article_id + "/" + cur_page;
                //cur_page-0+1: 先转str为int
                for (var m3_i = show_max-half+2, m3_n = cur_page-0+1; m3_i <= show_max, m3_n <= cur_page+half-1; m3_i ++, m3_n ++)
                {
                    var m3_id = "page" + m3_i;
                    var m3_e = document.getElementById(m3_id);
                    m3_e.style.display = "inline-block";
                    m3_e.innerHTML = m3_n;
                    m3_e.href = "/polls/msgboard/" + article_id + "/" + m3_n;
                }
            }
        }
    }

    function reply(comment_id, reply_id){
        var reply_forms = document.getElementsByName("reply-form");
        var iCount = reply_forms.length;
        for (var i = 0; i < iCount; ++i)
        {
            reply_forms[i].style.display = "none";
        }
        var e = document.getElementById("reply-form-" + comment_id);
        e.style.display = "block";
        e.lastElementChild.lastElementChild.previousElementSibling.setAttribute('rows', '3');
        var reply_name = "";
        if (reply_id == "-1")
        {
            reply_name = document.getElementById("comment-name-" + comment_id).innerHTML;
        }
        else
        {
            reply_name = document.getElementById("reply-name-" + comment_id  + "-" + reply_id).innerHTML;
        }
        var e2 = document.getElementById("reply-form-name-" + comment_id)
        e2.value = reply_name;
        e2.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling.placeholder = "回复 " + reply_name + ": ";
    }

    function submit_form(form_id){
        var e;
        if (form_id == "-1")
        {
            e = document.getElementById("reply-form-comment");
        }
        else
        {
            e = document.getElementById("reply-form-" + form_id);
        }
        if (e.lastElementChild.lastElementChild.previousElementSibling.value)
        {
            e.submit();
        }
        else
        {
            e.lastElementChild.firstElementChild.style.display = "inline-block";
            e.lastElementChild.setAttribute('class', 'form-group has-error');
        }
    }
</script>

<body onload="load()" class="body">
{% include 'polls/nav.html' %}
<div class="msg-board-page">
  <div class="msg-board-list">
      <div class="msg_item-outer-margin">
      <div class="msg-item">
        <form class="reply-display-comment" id="reply-form-comment"  name="reply-form-comment" method="post" action="">
            {% csrf_token %}
            <div class="form-group">
                <span class="text-danger pull-right hidden-span">请填写数据哦～</span>
                <input type="hidden" name="reply-form-replyto-name" value="" id="reply-form-comment-name"></input>
                <input type="hidden" name="reply-form-commentid" value="-1"></input>
                <input type="hidden" name="get-article-id" value=""></input>
                <input type="hidden" name="get-page" id="get-page-comment" value="1"></input>
                {{ form.content }}
                <input class="button" type="button" value="哔~" onclick="submit_form(-1)"></input>
                <!--
                    <input type="submit" value="ok">
                -->
            </div>
        </form>
      </div>
      </div>
    <div class="msg_item-outer-margin">
    {% for object in object_list %}
    <!-- one comment begin -->
    <div class="msg-item">
		<div class="msg-item-left">
		</div>
		<div class="msg-item-right">
			<div class="msg-item-right-main-content">
				<div class="msg-title">
                    <div class="msg-name" id="comment-name-{{ object.0 }}">{{ object.2.6 }}</div>
                    <div class="msg-level-head">Lv{{ object.2.8 }}</div>
                    <div class="msg-level-body">{{ object.2.9 }}</div>
                </div>
                <div class="msg-content new-line">{{ object.2.3 }}</div>
                <div class="msg-addition">This is Addition.<a class="reply-link-style" onclick="reply({{ object.0 }}, -1)">回复</a></div>
			</div>
                    {% for reply_item in object.3 %}
					<div class="msg-item-reply">
						<div class="msg-reply-left"></div>
						<div class="msg-reply-right">
					        <div class="msg-title">
                                <div class="msg-name" id="reply-name-{{ object.0 }}-{{ forloop.counter }}">{{ reply_item.6 }}</div>
                                <div class="msg-name">&nbsp;回复 {{ reply_item.5 }}</div>
                                <div class="msg-level-head">Lv{{ reply_item.8 }}</div>
                                <div class="msg-level-body">{{ reply_item.9 }}</div>
                            </div>
                            <div class="msg-content new-line">{{ reply_item.3 }}</div>
                            <div class="msg-addition">this is addi<a class="reply-link-style" onclick="reply({{ object.0 }}, {{ forloop.counter }})">回复</a></div>
						</div>
					</div>
                    {% endfor %}
                    <form class="reply-display" id="reply-form-{{ object.0 }}" name="reply-form" method="post" action="">
                            {% csrf_token %}
                            <div class="form-group">
                                <span class="text-danger pull-right hidden-span">请填写数据哦～</span>
                                <input type="hidden" name="reply-form-replyto-name" value="" id="reply-form-name-{{ object.0 }}"></input>
                                <input type="hidden" name="reply-form-commentid" value="{{ object.0 }}"></input>
                                <input type="hidden" name="get-article-id" value=""></input>
                                <input type="hidden" name="get-page" value=""></input>
                                {{ form.content }}
                                <input type="button" class="button" value="哔～" onclick="submit_form({{ object.0 }})"></input>
                                <!--
                                <input type="submit" value="ok"></input>
                                -->
                            </div>
                    </form>
                    <!-- 最后一条回复后面 -->
        			</div>
		        </div>
                <!-- one comment end -->
                {% endfor %}
                    <!-- 怎么回事
                    <a href="#" id="first-page98">&laquo;</a>
                    怎么回事 -->
                <div class="pag-center">
                    <div class="pagination">
                        <a href="#" id="first-page">&laquo;</a>
                        <a href="#" id="page1">1</a>
                        <a href="#" id="page2">2</a>
                        <a href="#" id="page3">3</a>
                        <a href="#" id="page4">4</a>
                        <a href="#" id="page5">5</a>
                        <a href="#" id="page6">6</a>
                        <a href="#" id="page7">7</a>
                        <a href="#" id="last-page">&raquo;</a>
                    </div>
                </div>

                </div>
                <div class="leave-margin-bottom">
                </div>
        </div>
    <div class="">
    </div>
</div>

<div class="hidden-messages" id="hidden-messages">
    {% for m in messages %}
    <div id="{{ m.tags }}">{{ m }}</div>
    {% endfor %}
</div>
</body>
</html>
